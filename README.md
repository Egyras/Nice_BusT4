# bust4
Nice Bus T4 protocol

Появилось желание разобраться в протоколе для управления воротами Nice.
Переспектива - дешёвые устройства на базе esp8266 с вебсервером и mqtt, для управлением из умного дома.

На текущий момент существуют заводские решения:
Nice Bidi-WiFi - пока не держал в руках, заказал
Nice BiDi-ZWave - для ZWave, у нас чаще Zigbee используют
IT4WIFI - цепляется через HomeKit

Альтернатива: дёргать через реле выводами SbS, Open, Close и считывать статус с лампы. Это работает, но хочется более элегантного решения с глубокой интеграцией.

Что знаю про BusT4:

Можно подключать нескоглько устройств
Длина кабеля до 1200м, значит скорость обмена должна быть небольшой
Судя по схемам Nice IBT4N, rba3-c, rba3-a, в основе лежит CAN-Bus с его железом.

Современные блоки управления приводами имеют разъем BusT4, на который выведены GND, +24V, Can-Rx, Can-Tx. 
Дальше в случае программатора OVIEW или IT4WIFI должен идти Nice IBT4N (обычный CAN-Трансивер) и само устройство.

Что сделано:
Подключил FTDI232 к GND, Can-Rx, Can-Tx. UART не был обнаружен.
Собрал CAN-Sniffer на основе ESP32 и подключил Can-Rx, Can-Tx привода к Can-Rx, Can-Tx esp32. Без кан-трансиверов. Не знаю, должно ли так вообще работать.
Данных не увидел. Может скорость не смог подобрать, может сниффер не годится, может без подключенных устройств BusT4 оттуда ничего не считаешь.


Что нужно сделать:
1. Подключить блок управления двигателем к устройству BusT4 и на осциллографе посмотреть скорость шины.
Измеряем длительность последнего импульса в пакете, делим миллион на эту длительность в миллисекундах.
2. Собрать другой кан-сниффер с кан-трансивером и получить пакеты.
3. Провести реверс-инжениринг, найти команды для Open, Close, режим калитки, Stop, получить статус.
4. Написать конфигурацию для EspHome, чтобы все данные поступали в Home Assistant.

Жду Oview и блок управления Wingo 5000.
