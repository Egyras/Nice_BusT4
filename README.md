# ESPHOME компонент для управления приводами Nice по протоколу Bus T4
Nice Bus T4 protocol

Появилось желание разобраться в протоколе для управления воротами Nice.
Переспектива - дешёвые устройства на базе esp8266 для управлением из умного дома.

Современные блоки управления приводами имеют разъем BusT4, на который выведены GND, +24V, Can-Rx, Can-Tx. 

BusT4:

Это измененный UART 19200 8n1 с uart.break длительностью 519us-590us перед каждым пакетом.
Можно подключать несколько устройств, для этого в физический уровень добавлены трансиверы CAN-BUS.
Физическая передача чаще происходит через CAN трансиверы, но CAN-фреймов нет.

Что сделано:
Подключил FTDI232 к GND, Can-Rx, Can-Tx. UART обнаружен только в момент поступания команды в шину. Пакеты видны и поддаются расшифровке.
Логическим анализатором увидел форму сигнала и состав посылок, подобрал параметры uart.
Успешно имитировал считанный пакет через Arduino Mega, привод реагирует.
Получил команды OPEN CLOSE и тд
Получил байт статуса привода
Считал основные команды, частично расшифровал значение байт.
Собрал прототип устройства, протестировал работу.

![alt text](img/Schematic_esphome_bust4_adapter.png "Схема адаптера bus-t4")


ESP8266 не совпадает по уровню сигнала с BUS T4, добавить преобразователь уровней 3.3В -> 5В для Tx на транзисторе.
Rx ESP толерантен к 5В, но для стабильной работы нужен диод. У меня работает со случайным германиевым, возможно и кремниевый подойдёт.

![alt text](img/hassio-bust4.png "Тест работы компонента bus-t4")


Компонент поддерживает отправку произвольной команды на привод через службу  ESPHome: nice_bust4_uart_raw_command в Home assystant.
```
SBS:   55 0c 00 03 00 81 01 05 86 01 82 01 64 e6 0c
Open:  55 0c 00 03 05 81 01 05 83 01 82 03 64 e4 0c
Close: 55 0c 00 03 05 81 01 05 83 01 82 04 64 e3 0c
Stop:  55 0c 00 03 00 81 01 05 86 01 82 02 64 e5 0c
```
![alt text](img/IMG_20220113_160221.jpg "Внешний вид прототипа устройства")

При старте ESP опрашивает подключенные к шине BusT4 устройства и выводит информацию о них в лог.
![log](img/log.png "Лог")

